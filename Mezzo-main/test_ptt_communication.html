<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTT é€šè¨Šç³»çµ±æ¸¬è©¦å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-connected {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-info {
            border-left-color: #3b82f6;
            color: #93c5fd;
        }

        .log-success {
            border-left-color: #10b981;
            color: #6ee7b7;
        }

        .log-error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .log-warning {
            border-left-color: #f59e0b;
            color: #fcd34d;
        }

        .messages-container {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        .message-bubble {
            margin-bottom: 15px;
            display: flex;
        }

        .message-bubble.sent {
            justify-content: flex-end;
        }

        .message-bubble.received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
        }

        .message-bubble.sent .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-bubble.received .message-content {
            background: #f3f4f6;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }

        .message-meta {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¡ PTT é€šè¨Šç³»çµ±æ¸¬è©¦å·¥å…·</h1>
            <p>æ¸¬è©¦ /WJI/PTT/* MQTT é€šè¨Šå”è­°</p>
        </div>

        <div class="content">
            <!-- å·¦å´ï¼šæ§åˆ¶é¢æ¿ -->
            <div class="panel">
                <h2>
                    <span class="status-indicator" id="wsStatus"></span>
                    æ§åˆ¶é¢æ¿
                </h2>

                <div class="form-group">
                    <label>ä¼ºæœå™¨ä½å€</label>
                    <input type="text" id="serverUrl" value="http://localhost:4000" />
                </div>

                <div class="form-group">
                    <label>PTT è¨­å‚™ ID (UUID)</label>
                    <input type="text" id="deviceId" value="TEST-USER-001" />
                </div>

                <div class="form-group">
                    <label>PTT é »é“ (Channel)</label>
                    <select id="channel">
                        <option value="channel1">é »é“ 1</option>
                        <option value="channel2">é »é“ 2</option>
                        <option value="channel3">é »é“ 3</option>
                        <option value="emergency">ç·Šæ€¥é »é“</option>
                        <option value="test">æ¸¬è©¦é »é“</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="connectWebSocket()">ğŸ”Œ é€£æ¥ WebSocket</button>
                    <button class="btn btn-danger" onclick="disconnectWebSocket()">â›” æ–·é–‹é€£æ¥</button>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ“ ç™¼é€æ–‡å­—è¨Šæ¯</h3>
                <div class="form-group">
                    <label>è¨Šæ¯å…§å®¹</label>
                    <textarea id="messageText" placeholder="è¼¸å…¥è¦ç™¼é€çš„è¨Šæ¯..."></textarea>
                </div>
                <button class="btn btn-success" onclick="sendTextMessage()">ğŸ’¬ ç™¼é€æ–‡å­—è¨Šæ¯</button>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ“ ç™¼é€ GPS</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>ç·¯åº¦</label>
                        <input type="text" id="gpsLat" value="25.033964" />
                    </div>
                    <div class="form-group">
                        <label>ç¶“åº¦</label>
                        <input type="text" id="gpsLon" value="121.564472" />
                    </div>
                </div>
                <button class="btn btn-success" onclick="sendGPS()">ğŸ“ ç™¼é€ GPS</button>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ†˜ ç·Šæ€¥åŠŸèƒ½</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>SOS ç·¯åº¦</label>
                        <input type="text" id="sosLat" value="25.033964" />
                    </div>
                    <div class="form-group">
                        <label>SOS ç¶“åº¦</label>
                        <input type="text" id="sosLon" value="121.564472" />
                    </div>
                </div>
                <button class="btn btn-danger" onclick="sendSOS()">ğŸ†˜ ç™¼é€ SOS</button>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ“¢ å»£æ’­è¨Šæ¯</h3>
                <div class="form-group">
                    <label>å»£æ’­å…§å®¹</label>
                    <textarea id="broadcastText" placeholder="è¼¸å…¥å»£æ’­è¨Šæ¯..."></textarea>
                </div>
                <button class="btn btn-warning" onclick="sendBroadcast()">ğŸ“¢ ç™¼é€å»£æ’­</button>
            </div>

            <!-- å³å´ï¼šè¨Šæ¯èˆ‡æ—¥èªŒ -->
            <div class="panel">
                <h2>ğŸ“Š å³æ™‚è¨Šæ¯</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="sentCount">0</div>
                        <div class="stat-label">å·²ç™¼é€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="receivedCount">0</div>
                        <div class="stat-label">å·²æ¥æ”¶</div>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px 0; font-size: 16px;">ğŸ’¬ è¨Šæ¯æ­·å²</h3>
                <div class="messages-container" id="messagesContainer">
                    <p style="text-align: center; color: #9ca3af;">å°šç„¡è¨Šæ¯</p>
                </div>

                <h3 style="margin: 20px 0 10px 0; font-size: 16px;">ğŸ“‹ ç³»çµ±æ—¥èªŒ</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">ç³»çµ±å·²å°±ç·’ï¼Œç­‰å¾…é€£æ¥...</div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
                    <button class="btn btn-primary" onclick="testServerConnection()">ğŸ” æ¸¬è©¦ä¼ºæœå™¨é€£æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let sentCount = 0;
        let receivedCount = 0;

        // å»ºç«‹ PTT è¨Šæ¯æ ¼å¼
        function createPTTMessage(tag, uuid, data) {
            const tagBuffer = new Uint8Array(32);
            const tagBytes = new TextEncoder().encode(tag);
            tagBuffer.set(tagBytes.slice(0, 32));

            const uuidBuffer = new Uint8Array(128);
            const uuidBytes = new TextEncoder().encode(uuid);
            uuidBuffer.set(uuidBytes.slice(0, 128));

            const dataBytes = new TextEncoder().encode(data);
            const combined = new Uint8Array(160 + dataBytes.length);
            combined.set(tagBuffer, 0);
            combined.set(uuidBuffer, 32);
            combined.set(dataBytes, 160);

            return Array.from(combined);
        }

        // ç™¼é€ PTT è¨Šæ¯åˆ°å¾Œç«¯
        async function publishPTT(topic, tag, data) {
            const serverUrl = document.getElementById('serverUrl').value;
            const deviceId = document.getElementById('deviceId').value;
            const message = createPTTMessage(tag, deviceId, data);

            try {
                const response = await fetch(`${serverUrl}/ptt/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, message, encoding: 'binary' })
                });

                if (response.ok) {
                    const result = await response.json();
                    logMessage(`âœ… ç™¼é€æˆåŠŸ: ${topic}`, 'success');
                    sentCount++;
                    updateStats();
                    return true;
                } else {
                    const error = await response.text();
                    logMessage(`âŒ ç™¼é€å¤±æ•—: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                logMessage(`âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
                return false;
            }
        }

        // ç™¼é€æ–‡å­—è¨Šæ¯
        async function sendTextMessage() {
            const channel = document.getElementById('channel').value;
            const text = document.getElementById('messageText').value;

            if (!text.trim()) {
                alert('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹');
                return;
            }

            const topic = `/WJI/PTT/${channel}/CHANNEL_ANNOUNCE`;
            const success = await publishPTT(topic, 'TEXT_MESSAGE', text);

            if (success) {
                addMessage(text, true);
                document.getElementById('messageText').value = '';
            }
        }

        // ç™¼é€ GPS
        async function sendGPS() {
            const channel = document.getElementById('channel').value;
            const deviceId = document.getElementById('deviceId').value;
            const lat = document.getElementById('gpsLat').value;
            const lon = document.getElementById('gpsLon').value;

            const topic = `/WJI/PTT/${channel}/GPS`;
            const data = `${deviceId},${lat},${lon}`;

            await publishPTT(topic, 'GPS', data);
        }

        // ç™¼é€ SOS
        async function sendSOS() {
            const channel = document.getElementById('channel').value;
            const lat = document.getElementById('sosLat').value;
            const lon = document.getElementById('sosLon').value;

            const topic = `/WJI/PTT/${channel}/SOS`;
            const data = `${lat},${lon}`;

            await publishPTT(topic, 'SOS', data);
        }

        // ç™¼é€å»£æ’­
        async function sendBroadcast() {
            const channel = document.getElementById('channel').value;
            const text = document.getElementById('broadcastText').value;

            if (!text.trim()) {
                alert('è«‹è¼¸å…¥å»£æ’­å…§å®¹');
                return;
            }

            const topic = `/WJI/PTT/${channel}/CHANNEL_ANNOUNCE`;
            const success = await publishPTT(topic, 'BROADCAST', text);

            if (success) {
                document.getElementById('broadcastText').value = '';
            }
        }

        // é€£æ¥ WebSocket
        function connectWebSocket() {
            const serverUrl = document.getElementById('serverUrl').value;
            const wsUrl = serverUrl.replace('http', 'ws').replace(':4000', ':4001');

            logMessage(`ğŸ”Œ æ­£åœ¨é€£æ¥ WebSocket: ${wsUrl}`, 'info');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                logMessage('âœ… WebSocket å·²é€£æ¥', 'success');
                updateConnectionStatus(true);
                ws.send(JSON.stringify({ type: 'request_messages' }));
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'pong') return;

                    logMessage(`ğŸ“¨ æ”¶åˆ°è¨Šæ¯: ${data.type}`, 'info');

                    if (data.type === 'message' || data.type === 'ptt_broadcast') {
                        const msg = data.message;
                        addMessage(`[${msg.from}] ${msg.text}`, false);
                        receivedCount++;
                        updateStats();
                    }

                    if (data.type === 'messages_history') {
                        logMessage(`ğŸ“œ è¼‰å…¥æ­·å²è¨Šæ¯: ${data.messages.length} å‰‡`, 'info');
                    }
                } catch (error) {
                    logMessage(`âŒ è§£æéŒ¯èª¤: ${error.message}`, 'error');
                }
            };

            ws.onerror = (error) => {
                logMessage(`âŒ WebSocket éŒ¯èª¤`, 'error');
                updateConnectionStatus(false);
            };

            ws.onclose = () => {
                logMessage('ğŸ”Œ WebSocket å·²æ–·é–‹', 'warning');
                updateConnectionStatus(false);
            };
        }

        // æ–·é–‹ WebSocket
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                logMessage('â›” å·²ä¸»å‹•æ–·é–‹é€£æ¥', 'info');
            }
        }

        // æ¸¬è©¦ä¼ºæœå™¨é€£æ¥
        async function testServerConnection() {
            const serverUrl = document.getElementById('serverUrl').value;
            logMessage(`ğŸ” æ­£åœ¨æ¸¬è©¦ä¼ºæœå™¨: ${serverUrl}/health`, 'info');

            try {
                const response = await fetch(`${serverUrl}/health`);
                if (response.ok) {
                    const data = await response.json();
                    logMessage(`âœ… ä¼ºæœå™¨æ­£å¸¸é‹è¡Œ`, 'success');
                    logMessage(`ğŸ“Š ç‹€æ…‹: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    logMessage(`âŒ ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status}`, 'error');
                }
            } catch (error) {
                logMessage(`âŒ ç„¡æ³•é€£æ¥ä¼ºæœå™¨: ${error.message}`, 'error');
            }
        }

        // æ–°å¢è¨Šæ¯åˆ°ä»‹é¢
        function addMessage(text, isSent) {
            const container = document.getElementById('messagesContainer');

            // æ¸…é™¤ç©ºç‹€æ…‹è¨Šæ¯
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }

            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;

            const content = document.createElement('div');
            content.className = 'message-content';

            const textDiv = document.createElement('div');
            textDiv.textContent = text;

            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = new Date().toLocaleTimeString('zh-TW');

            content.appendChild(textDiv);
            content.appendChild(meta);
            bubble.appendChild(content);
            container.appendChild(bubble);

            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        // è¨˜éŒ„æ—¥èªŒ
        function logMessage(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('zh-TW')}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('wsStatus');
            indicator.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('receivedCount').textContent = receivedCount;
        }

        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">æ—¥èªŒå·²æ¸…é™¤</div>';
        }

        // åˆå§‹åŒ–
        updateConnectionStatus(false);
    </script>
</body>
</html>
